# Mise configuration for AstroWorkbench
# https://mise.jdx.dev

[hooks]
enter = "echo 'I entered the project'"
leave = "echo 'I left the project'"

[env]
STARNET = "{{env.HOMEBREW_PREFIX}}/bin/starnet2"

[task_config]
dir = "{{config_root}}"

# ============================================================================
# Workspace Management
# ============================================================================

[tasks.clean]
description = "Delete Siril artifacts and scratch directories"
alias = "c"
run = "rm -rf process results masters"

[tasks.purge]
description = "Delete entire workspace except config files"
confirm = "Are you sure you want to delete the entire workspace?"
run = 'find . -maxdepth 1 ! -name "readme.md" ! -name ".*" -exec rm -rf {} +'

# ============================================================================
# Data Import/Export
# ============================================================================

[tasks."import:darks"]
description = "Import dark frames"
hide = true
usage = 'flag "--source <source>" help="Source directory path"'
depends = ["init"]
run = 'rsync -a --progress "${usage_source?}/Dark/*.fit" darks/'

[tasks."import:biases"]
description = "Import bias frames"
hide = true
usage = 'flag "--source <source>" help="Source directory path"'
depends = ["init"]
run = 'rsync -a --progress "${usage_source?}/Bias/*.fit" biases/'

[tasks."import:flats"]
description = "Import flat frames"
hide = true
usage = 'flag "--source <source>" help="Source directory path"'
depends = ["init"]
run = 'rsync -a --progress "${usage_source?}/Flat/*.fit" flats/'

[tasks."import:lights"]
description = "Import light frames"
hide = true
usage = '''
flag "--source <source>" help="Source directory path"
arg "<object>" help="Object name (e.g., M31, NGC7000)"
'''
depends = ["init"]
run = 'rsync -a --progress "${usage_source?}/Light/${usage_object?}/*.fit" lights/'

[tasks.import]
description = "Copy ASIAIR data from external drive to workspace (runs in parallel)"
alias = "im"
usage = '''
flag "--source <source>" help="Source directory path"
arg "<object>" help="Object name (e.g., M31, NGC7000)"
'''
depends = ["import:darks", "import:biases", "import:flats", "import:lights"]
run = 'echo "Import complete!"'

[tasks.archive]
description = "Archive FITS/PSD files as timestamped tarball"
alias = "tar"
usage = 'arg "<object>" help="Object name for archive filename"'
run = """
find .. -name "*.fit" -or -name "*.psd" | cut -c4- > /tmp/archive-files.txt
tar -vcaf "$(date +%Y.%m.%d)_${usage_object?}.tar.zst" -C .. -T /tmp/archive-files.txt
rm /tmp/archive-files.txt
"""

# ============================================================================
# Image Processing Pipeline
# ============================================================================

[tasks."convert-tif"]
description = "Convert FITS file to 16-bit TIFF using Siril"
alias = "tif"
usage = 'arg "<file>" help="FITS filename without .fit extension"'
run = """
siril-cli -d . -s - <<SNET
requires 1.3.0
load ${usage_file?}.fit
savetif ${usage_file?}
SNET
"""

# ============================================================================
# Internal Helper Tasks
# ============================================================================

[tasks.init]
description = "Create workspace directory structure"
hide = true
alias = "i"
outputs = ["biases/", "flats/", "darks/", "lights/"]
run = "mkdir -p biases flats darks lights"

[tasks.check-starnet]
description = "Verify StarNet2 is installed"
hide = true
run = """
if [ ! -x "$STARNET" ]; then
  echo "Error: StarNet2 not found at $STARNET"
  echo "Install with: brew install starnet2"
  exit 1
fi
"""
